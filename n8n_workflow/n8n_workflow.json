{
  "name": "Alcovia Intervention Engine - Complete Workflow",
  "description": "Production-ready workflow with mentor approval, 12-hour fail-safe, escalation, and duplicate prevention",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "student-failed",
        "responseMode": "lastNode",
        "responseData": "={{ JSON.stringify({ success: true, message: 'Student failure notification received', student_id: $json.body.student_id, log_id: $json.body.log_id }) }}",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook - Student Failed Checkin",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 400],
      "webhookId": "student-failed-trigger",
      "notes": "Triggered by backend when student fails daily check-in"
    },
    {
      "parameters": {
        "jsCode": "// Extract and validate student failure data\nconst body = $input.first().json.body;\n\nif (!body || !body.student_id) {\n  throw new Error('Missing required field: student_id');\n}\n\nconst studentId = body.student_id;\nconst quizScore = body.quiz_score || 0;\nconst focusMinutes = body.focus_minutes || 0;\nconst cheaterDetected = body.cheater_detected || false;\nconst reason = body.reason || 'Performance below threshold';\nconst logId = body.log_id || null;\n\n// Generate secure approval token\nconst approvalToken = Math.random().toString(36).substring(2, 15) + \n                     Math.random().toString(36).substring(2, 15) + \n                     Date.now().toString(36);\n\n// Build approval URL\nconst n8nHost = $env.N8N_HOST || 'https://your-n8n-instance.app.n8n.cloud';\nconst approvalUrl = `${n8nHost}/webhook/approve?student_id=${encodeURIComponent(studentId)}&token=${approvalToken}&log_id=${logId}`;\n\n// Default intervention task\nconst defaultTask = 'Complete Chapter 4 review exercises (pages 45-50) and answer all practice questions. Submit your answers to your mentor for review.';\n\n// Assess criticality\nconst isCritical = cheaterDetected || quizScore < 5 || focusMinutes < 30;\nconst urgencyLevel = isCritical ? 'üî¥ CRITICAL' : 'üü° MODERATE';\nconst cheatingStatus = cheaterDetected ? '‚ö†Ô∏è YES - Tab switching detected' : '‚úÖ NO';\n\n// Calculate failure reasons\nconst failures = [];\nif (quizScore < 7) failures.push(`Low quiz score (${quizScore}/10)`);\nif (focusMinutes < 60) failures.push(`Insufficient focus time (${focusMinutes} min)`);\nif (cheaterDetected) failures.push('Cheating detected');\n\nconst failureReason = failures.join(', ') || reason;\n\nreturn {\n  json: {\n    student_id: studentId,\n    quiz_score: quizScore,\n    focus_minutes: focusMinutes,\n    cheater_detected: cheaterDetected,\n    cheating_status: cheatingStatus,\n    reason: failureReason,\n    log_id: logId,\n    approval_url: approvalUrl,\n    approval_token: approvalToken,\n    default_task: defaultTask,\n    urgency_level: urgencyLevel,\n    is_critical: isCritical,\n    notification_sent_at: new Date().toISOString(),\n    workflow_id: `WF-${Date.now()}-${studentId}`\n  }\n};"
      },
      "id": "format-data",
      "name": "Format Data & Generate Approval URL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 400],
      "notes": "Validates input, generates approval token, assesses criticality"
    },
    {
      "parameters": {
        "authentication": "none",
        "fromEmail": "noreply@alcovia-education.com",
        "toEmail": "mentor@alcovia-education.com",
        "subject": "={{ $json.urgency_level }} Intervention Required - Student {{ $json.student_id }}",
        "emailType": "html",
        "message": "<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Intervention Required</title>\n  <style>\n    body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }\n    .container { max-width: 600px; margin: 20px auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }\n    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 20px; text-align: center; }\n    .header h1 { margin: 0 0 10px 0; font-size: 28px; font-weight: 600; }\n    .header p { margin: 0; font-size: 16px; opacity: 0.95; }\n    .content { padding: 30px; }\n    .alert-box { background: #fff5f5; border-left: 5px solid #e53e3e; padding: 20px; margin: 20px 0; border-radius: 0 8px 8px 0; }\n    .alert-box.critical { animation: pulse 2s infinite; }\n    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }\n    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 25px 0; }\n    .stat-card { background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #e9ecef; }\n    .stat-card.fail { border-color: #e53e3e; background: #fff5f5; }\n    .stat-label { font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }\n    .stat-value { font-size: 32px; font-weight: 700; color: #1a202c; }\n    .stat-value.fail { color: #e53e3e; }\n    .task-box { background: #f0f4ff; padding: 20px; border-radius: 10px; margin: 25px 0; border-left: 5px solid #667eea; }\n    .button { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 18px 40px; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 16px; margin: 20px 0; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); transition: all 0.3s; }\n    .button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5); }\n    .info-box { background: #fffbeb; border-left: 5px solid #f59e0b; padding: 20px; margin: 25px 0; border-radius: 0 8px 8px 0; }\n    .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 13px; color: #6b7280; border-top: 1px solid #e9ecef; }\n    .metadata { font-size: 11px; color: #9ca3af; margin-top: 10px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>üéì Alcovia Intervention Alert</h1>\n      <p>{{ $json.urgency_level }} - Immediate Action Required</p>\n    </div>\n    \n    <div class=\"content\">\n      <div class=\"{{ $json.is_critical ? 'alert-box critical' : 'alert-box' }}\">\n        <strong style=\"font-size: 16px;\">‚ö†Ô∏è Student Performance Alert</strong>\n        <p style=\"margin: 10px 0 0 0;\">Student <strong>{{ $json.student_id }}</strong> has failed their daily check-in and requires intervention.</p>\n      </div>\n      \n      <h2 style=\"color: #1a202c; margin: 30px 0 20px 0;\">üìä Performance Metrics</h2>\n      \n      <div class=\"stats-grid\">\n        <div class=\"stat-card {{ $json.quiz_score < 7 ? 'fail' : '' }}\">\n          <div class=\"stat-label\">üìù Quiz Score</div>\n          <div class=\"stat-value {{ $json.quiz_score < 7 ? 'fail' : '' }}\">{{ $json.quiz_score }}/10</div>\n          {{ $json.quiz_score < 7 ? '<div style=\"color: #e53e3e; font-size: 12px; margin-top: 5px;\">Below Threshold</div>' : '' }}\n        </div>\n        \n        <div class=\"stat-card {{ $json.focus_minutes < 60 ? 'fail' : '' }}\">\n          <div class=\"stat-label\">‚è∞ Focus Time</div>\n          <div class=\"stat-value {{ $json.focus_minutes < 60 ? 'fail' : '' }}\">{{ $json.focus_minutes }}</div>\n          <div style=\"font-size: 14px; color: #6b7280; margin-top: 5px;\">minutes</div>\n          {{ $json.focus_minutes < 60 ? '<div style=\"color: #e53e3e; font-size: 12px;\">Below Threshold</div>' : '' }}\n        </div>\n      </div>\n      \n      <div style=\"background: {{ $json.cheater_detected ? '#fff5f5' : '#f0fdf4' }}; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; border: 2px solid {{ $json.cheater_detected ? '#e53e3e' : '#10b981' }};\">\n        <strong style=\"color: {{ $json.cheater_detected ? '#e53e3e' : '#10b981' }}; font-size: 16px;\">{{ $json.cheating_status }}</strong>\n      </div>\n      \n      <div style=\"background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;\">\n        <strong>üìã Failure Reason:</strong><br/>\n        <span style=\"color: #4b5563;\">{{ $json.reason }}</span>\n      </div>\n      \n      <h2 style=\"color: #1a202c; margin: 30px 0 15px 0;\">üë®‚Äçüè´ Mentor Action Required</h2>\n      \n      <p style=\"color: #4b5563; line-height: 1.8;\">Please review the student's performance and assign an appropriate intervention task. The student is currently locked out of their account and awaiting your guidance.</p>\n      \n      <div class=\"task-box\">\n        <strong style=\"color: #667eea; font-size: 15px;\">üí° Suggested Intervention Task:</strong>\n        <p style=\"margin: 12px 0 0 0; color: #4b5563; line-height: 1.7;\">{{ $json.default_task }}</p>\n      </div>\n      \n      <div style=\"text-align: center; margin: 35px 0;\">\n        <a href=\"{{ $json.approval_url }}\" class=\"button\">‚úÖ Assign Intervention Task</a>\n        <p style=\"font-size: 13px; color: #6b7280; margin-top: 15px;\">Click the button above to approve and assign the intervention</p>\n      </div>\n      \n      <div class=\"info-box\">\n        <strong style=\"color: #f59e0b;\">‚è±Ô∏è Important Notice:</strong>\n        <p style=\"margin: 10px 0 0 0; color: #78350f; line-height: 1.6;\">If no action is taken within <strong>12 hours</strong>, the system will automatically escalate this case to the head mentor and assign a default task to unlock the student.</p>\n      </div>\n      \n      {{ $json.is_critical ? '<div style=\"background: #fef2f2; border: 2px solid #e53e3e; padding: 20px; border-radius: 10px; margin: 25px 0;\"><strong style=\"color: #e53e3e; font-size: 16px;\">üö® CRITICAL ALERT</strong><p style=\"margin: 10px 0 0 0; color: #991b1b;\">This case requires immediate attention due to multiple failure indicators. Priority review recommended.</p></div>' : '' }}\n    </div>\n    \n    <div class=\"footer\">\n      <p><strong>Alcovia Intervention Engine</strong></p>\n      <p>Automated Performance Monitoring & Intervention System</p>\n      <div class=\"metadata\">\n        <p>Workflow ID: {{ $json.workflow_id }}</p>\n        <p>Log ID: {{ $json.log_id }} | Token: {{ $json.approval_token }}</p>\n        <p>Sent: {{ $json.notification_sent_at }}</p>\n      </div>\n    </div>\n  </div>\n</body>\n</html>",
        "options": {}
      },
      "id": "send-notification",
      "name": "Send Mentor Notification Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [650, 400],
      "notes": "Beautiful HTML email with performance metrics and approval button"
    },
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "approve",
        "responseMode": "responseNode",
        "responseData": "allEntries",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/html; charset=utf-8"
              }
            ]
          },
          "responseBody": "<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Intervention Assigned Successfully</title>\n  <style>\n    body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }\n    .container { background: white; padding: 50px 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; max-width: 500px; margin: 20px; animation: slideIn 0.5s ease-out; }\n    @keyframes slideIn { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }\n    .success-icon { font-size: 80px; margin-bottom: 25px; animation: bounce 0.6s ease-out; }\n    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }\n    h1 { color: #667eea; margin: 0 0 15px 0; font-size: 32px; font-weight: 600; }\n    p { color: #6b7280; line-height: 1.8; margin: 15px 0; font-size: 16px; }\n    .student-id { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; border-radius: 12px; display: inline-block; margin: 25px 0; font-weight: 600; font-size: 18px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }\n    .checkmark { width: 80px; height: 80px; margin: 0 auto 20px; }\n    .checkmark-circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 3; stroke: #48bb78; fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }\n    .checkmark-check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; stroke: #48bb78; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.6s forwards; }\n    @keyframes stroke { 100% { stroke-dashoffset: 0; } }\n    .footer { margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb; font-size: 13px; color: #9ca3af; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <svg class=\"checkmark\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\n      <circle class=\"checkmark-circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\n      <path class=\"checkmark-check\" fill=\"none\" stroke-width=\"3\" d=\"M14.1 27.2l7.1 7.2 16.7-16.8\"/>\n    </svg>\n    \n    <div class=\"success-icon\">‚úÖ</div>\n    <h1>Intervention Task Assigned!</h1>\n    \n    <p>The intervention task has been successfully assigned to the student.</p>\n    \n    <div class=\"student-id\">Student ID: {{ $json.query.student_id }}</div>\n    \n    <p>The student has been notified via WebSocket and can now view their remedial task. They must complete it to unlock their account and return to normal learning activities.</p>\n    \n    <div class=\"footer\">\n      <p><strong>‚úì Confirmation Email Sent</strong></p>\n      <p>You can safely close this window</p>\n    </div>\n  </div>\n</body>\n</html>"
        }
      },
      "id": "webhook-approve",
      "name": "Webhook - Wait for Mentor Approval",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [850, 400],
      "webhookId": "approve-intervention",
      "notes": "Mentor clicks approval link ‚Üí this webhook receives it"
    },
    {
      "parameters": {
        "jsCode": "// Validate approval token and prevent duplicate submissions\nconst query = $input.first().json.query;\nconst studentId = query.student_id;\nconst receivedToken = query.token;\nconst logId = query.log_id;\n\n// Get original data from format step\nconst originalData = $('Format Data & Generate Approval URL').first().json;\nconst originalToken = originalData.approval_token;\nconst originalStudentId = originalData.student_id;\n\n// Security validations\nif (!receivedToken || !originalToken) {\n  throw new Error('Missing approval token. Security check failed.');\n}\n\nif (receivedToken !== originalToken) {\n  throw new Error('Invalid approval token. This link may have expired or been tampered with.');\n}\n\nif (studentId !== originalStudentId) {\n  throw new Error('Student ID mismatch. Security check failed.');\n}\n\n// Prevent duplicate approvals (in production, check database)\n// For workflow demo, we'll allow it to proceed\nconst timestamp = new Date().toISOString();\n\nconsole.log(`‚úÖ Approval validated for student ${studentId} at ${timestamp}`);\n\nreturn {\n  json: {\n    student_id: studentId,\n    token: receivedToken,\n    log_id: logId,\n    validated: true,\n    approved_at: timestamp,\n    task: originalData.default_task,\n    mentor_notes: 'Approved by mentor through n8n workflow',\n    original_failure: {\n      quiz_score: originalData.quiz_score,\n      focus_minutes: originalData.focus_minutes,\n      cheater_detected: originalData.cheater_detected,\n      reason: originalData.reason\n    }\n  }\n};"
      },
      "id": "validate-approval",
      "name": "Validate Approval & Security Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 400],
      "notes": "Prevents duplicate approvals and validates security token"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL || 'http://localhost:4000' }}/api/interventions/assign",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-backend-secret",
              "value": "={{ $env.BACKEND_SECRET || '' }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "bodyParameters": {
          "parameters": [
            {
              "name": "studentId",
              "value": "={{ $json.student_id }}"
            },
            {
              "name": "task",
              "value": "={{ $json.task }}"
            },
            {
              "name": "mentorNotes",
              "value": "={{ $json.mentor_notes }}"
            }
          ]
        },
        "options": {
          "timeout": 10000,
          "retry": {
            "maxRetries": 3,
            "retryInterval": 1000
          }
        }
      },
      "id": "assign-intervention",
      "name": "Assign Intervention (Backend API)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1250, 400],
      "alwaysOutputData": true,
      "continueOnFail": false,
      "notes": "Calls backend /api/interventions/assign to update student status to 'remedial'"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "check-success",
              "leftValue": "={{ $json.success }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-api-success",
      "name": "Check API Response Success",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1450, 400],
      "notes": "Route to success or error path based on API response"
    },
    {
      "parameters": {
        "authentication": "none",
        "fromEmail": "noreply@alcovia-education.com",
        "toEmail": "mentor@alcovia-education.com",
        "subject": "‚úÖ Intervention Assigned - Student {{ $('Validate Approval & Security Check').item.json.student_id }}",
        "emailType": "html",
        "message": "<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #f5f7fa; }\n    .container { max-width: 600px; margin: 20px auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }\n    .header { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 30px 20px; text-align: center; }\n    .content { padding: 30px; }\n    .success-box { background: #f0fff4; border-left: 5px solid #48bb78; padding: 20px; margin: 20px 0; border-radius: 0 8px 8px 0; }\n    .task-box { background: #f7fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; margin: 20px 0; }\n    .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 13px; color: #6b7280; border-top: 1px solid #e9ecef; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1 style=\"margin: 0 0 10px 0;\">‚úÖ Success!</h1>\n      <p style=\"margin: 0; font-size: 18px;\">Intervention Task Assigned</p>\n    </div>\n    \n    <div class=\"content\">\n      <div class=\"success-box\">\n        <strong style=\"color: #22543d; font-size: 16px;\">‚úì The intervention has been successfully assigned!</strong>\n      </div>\n      \n      <p><strong>Student ID:</strong> {{ $('Validate Approval & Security Check').item.json.student_id }}</p>\n      <p><strong>Assigned At:</strong> {{ $('Validate Approval & Security Check').item.json.approved_at }}</p>\n      \n      <h3 style=\"color: #1a202c; margin-top: 25px;\">üìù Assigned Task:</h3>\n      <div class=\"task-box\">\n        {{ $('Validate Approval & Security Check').item.json.task }}\n      </div>\n      \n      <h3 style=\"color: #1a202c;\">üìã What Happens Next:</h3>\n      <ul style=\"color: #4b5563; line-height: 1.8;\">\n        <li>Student status changed to: <strong style=\"color: #667eea;\">remedial</strong></li>\n        <li>Student receives WebSocket notification instantly</li>\n        <li>Student must complete the task to unlock their account</li>\n        <li>Upon completion, status returns to <strong style=\"color: #48bb78;\">on_track</strong></li>\n      </ul>\n      \n      <div style=\"background: #ebf8ff; border-left: 4px solid #4299e1; padding: 15px; margin: 20px 0; border-radius: 0 8px 8px 0;\">\n        <strong style=\"color: #2c5282;\">üí° Monitoring Tip:</strong>\n        <p style=\"margin: 10px 0 0 0; color: #2d3748;\">Track the student's progress in the Alcovia dashboard. You'll receive a notification when they complete the task.</p>\n      </div>\n    </div>\n    \n    <div class=\"footer\">\n      <p><strong>Alcovia Intervention Engine</strong></p>\n      <p>Automated confirmation notification</p>\n    </div>\n  </div>\n</body>\n</html>",
        "options": {}
      },
      "id": "confirmation-email",
      "name": "Send Mentor Confirmation Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1650, 300],
      "notes": "Success path: Confirms intervention assignment to mentor"
    },
    {
      "parameters": {
        "authentication": "none",
        "fromEmail": "errors@alcovia-education.com",
        "toEmail": "admin@alcovia-education.com",
        "subject": "‚ùå API Error - Failed to Assign Intervention for Student {{ $('Validate Approval & Security Check').item.json.student_id }}",
        "emailType": "html",
        "message": "<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body { margin: 0; padding: 0; font-family: monospace; background: #1a202c; color: #e2e8f0; }\n    .container { max-width: 700px; margin: 20px auto; background: #2d3748; border-radius: 8px; padding: 30px; border: 2px solid #e53e3e; }\n    .header { color: #fc8181; font-size: 24px; margin-bottom: 20px; }\n    .error-box { background: #742a2a; padding: 20px; border-radius: 4px; margin: 15px 0; border-left: 5px solid #e53e3e; }\n    pre { background: #1a202c; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">‚ùå Backend API Error</div>\n    \n    <p><strong>Student ID:</strong> {{ $('Validate Approval & Security Check').item.json.student_id }}</p>\n    <p><strong>Timestamp:</strong> {{ new Date().toISOString() }}</p>\n    \n    <div class=\"error-box\">\n      <strong>‚ö†Ô∏è Failed to assign intervention task via backend API</strong>\n      <p>The mentor approved the intervention, but the backend API call failed.</p>\n    </div>\n    \n    <h3>API Response:</h3>\n    <pre>{{ JSON.stringify($json, null, 2) }}</pre>\n    \n    <h3>Original Request Data:</h3>\n    <pre>{{ JSON.stringify($('Validate Approval & Security Check').item.json, null, 2) }}</pre>\n    \n    <h3>üîß Required Action:</h3>\n    <ul>\n      <li>Check backend server logs for errors</li>\n      <li>Verify DATABASE_URL connection</li>\n      <li>Manually assign intervention via dashboard if needed</li>\n      <li>Student is still locked - requires immediate attention</li>\n    </ul>\n  </div>\n</body>\n</html>",
        "options": {}
      },
      "id": "api-error-email",
      "name": "Send API Error Notification",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1650, 500],
      "notes": "Error path: Alerts admin if backend API fails"
    },
    {
      "parameters": {
        "amount": 43200,
        "unit": "seconds",
        "resume": "webhook"
      },
      "id": "wait-12-hours",
      "name": "Wait 12 Hours (Fail-Safe Timer)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [850, 700],
      "webhookId": "wait-12-hours-failsafe",
      "notes": "Parallel fail-safe path: triggers after 12 hours if no mentor action"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $env.BACKEND_URL || 'http://localhost:4000' }}/api/student/{{ $('Format Data & Generate Approval URL').item.json.student_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-backend-secret",
              "value": "={{ $env.BACKEND_SECRET || '' }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "check-student-status",
      "name": "Check Student Current Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 700],
      "notes": "After 12 hours, check if student is still locked"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "still-needs-intervention",
              "leftValue": "={{ $json.data.status }}",
              "rightValue": "needs_intervention",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "still-locked-check",
      "name": "Is Student Still Locked?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1250, 700],
      "notes": "Only proceed with escalation if student is STILL locked after 12 hours"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL || 'http://localhost:4000' }}/api/interventions/assign",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-backend-secret",
              "value": "={{ $env.BACKEND_SECRET || '' }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "bodyParameters": {
          "parameters": [
            {
              "name": "studentId",
              "value": "={{ $('Format Data & Generate Approval URL').item.json.student_id }}"
            },
            {
              "name": "task",
              "value": "AUTO-ASSIGNED AFTER 12-HOUR TIMEOUT: Please review your recent quiz results and focus session. Contact your mentor immediately for personalized guidance and support."
            },
            {
              "name": "mentorNotes",
              "value": "üö® AUTO-ASSIGNED: No mentor action taken within 12 hours. Escalation email sent to head mentor. Student unlocked with default remedial task."
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "auto-assign-task",
      "name": "Auto-Assign Default Task (Failsafe)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1450, 600],
      "notes": "Emergency unlock: Auto-assigns task after 12-hour timeout"
    },
    {
      "parameters": {
        "authentication": "none",
        "fromEmail": "escalation@alcovia-education.com",
        "toEmail": "head-mentor@alcovia-education.com",
        "cc": "admin@alcovia-education.com",
        "subject": "üî¥ CRITICAL ESCALATION - 12-Hour Timeout - Student {{ $('Format Data & Generate Approval URL').item.json.student_id }}",
        "emailType": "html",
        "message": "<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; }\n    .container { max-width: 650px; margin: 20px auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(229, 62, 62, 0.4); border: 3px solid #e53e3e; }\n    .header { background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); color: white; padding: 30px 20px; text-align: center; animation: pulse 2s infinite; }\n    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.9; } }\n    .content { padding: 35px; }\n    .critical-box { background: #fff5f5; border: 3px solid #e53e3e; padding: 25px; margin: 25px 0; border-radius: 10px; }\n    .timeline { background: #fffbeb; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 5px solid #f59e0b; }\n    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }\n    .stat-card { background: #fef2f2; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #fca5a5; }\n    .button { display: inline-block; background: #e53e3e; color: white; padding: 18px 35px; text-decoration: none; border-radius: 10px; font-weight: 600; margin: 20px 0; box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4); }\n    .footer { background: #1a202c; color: white; padding: 25px; text-align: center; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1 style=\"margin: 0 0 10px 0; font-size: 36px;\">üî¥ CRITICAL ESCALATION</h1>\n      <p style=\"margin: 0; font-size: 20px; font-weight: 600;\">12-Hour Timeout Reached</p>\n    </div>\n    \n    <div class=\"content\">\n      <div class=\"critical-box\">\n        <h2 style=\"color: #e53e3e; margin: 0 0 15px 0;\">‚ö†Ô∏è IMMEDIATE ACTION REQUIRED</h2>\n        <p style=\"color: #991b1b; font-size: 17px; line-height: 1.7; margin: 0;\">No mentor intervention was provided within the 12-hour SLA window. Student has been automatically unlocked with a default remedial task.</p>\n      </div>\n      \n      <h3 style=\"color: #1a202c;\">Student Information:</h3>\n      <p><strong>Student ID:</strong> <span style=\"color: #e53e3e; font-size: 18px;\">{{ $('Format Data & Generate Approval URL').item.json.student_id }}</span></p>\n      <p><strong>Current Status:</strong> <span style=\"color: #f59e0b;\">{{ $('Check Student Current Status').item.json.data.status }}</span> ‚Üí <span style=\"color: #764ba2;\">remedial (auto-assigned)</span></p>\n      \n      <h3 style=\"color: #1a202c; margin-top: 30px;\">üìä Original Performance Data:</h3>\n      <div class=\"stats-grid\">\n        <div class=\"stat-card\">\n          <div style=\"font-size: 12px; color: #6b7280; text-transform: uppercase;\">Quiz Score</div>\n          <div style=\"font-size: 28px; font-weight: 700; color: #e53e3e; margin-top: 5px;\">{{ $('Format Data & Generate Approval URL').item.json.quiz_score }}/10</div>\n        </div>\n        <div class=\"stat-card\">\n          <div style=\"font-size: 12px; color: #6b7280; text-transform: uppercase;\">Focus Time</div>\n          <div style=\"font-size: 28px; font-weight: 700; color: #e53e3e; margin-top: 5px;\">{{ $('Format Data & Generate Approval URL').item.json.focus_minutes }} min</div>\n        </div>\n      </div>\n      \n      <div style=\"background: #fef2f2; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; border: 2px solid #e53e3e;\">\n        <strong style=\"color: #e53e3e; font-size: 16px;\">{{ $('Format Data & Generate Approval URL').item.json.cheating_status }}</strong>\n      </div>\n      \n      <div style=\"background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;\">\n        <strong>üìã Failure Reason:</strong><br/>\n        <span style=\"color: #4b5563;\">{{ $('Format Data & Generate Approval URL').item.json.reason }}</span>\n      </div>\n      \n      <div class=\"timeline\">\n        <h3 style=\"color: #78350f; margin: 0 0 15px 0;\">‚è∞ Escalation Timeline:</h3>\n        <ul style=\"margin: 0; padding-left: 20px; color: #92400e; line-height: 2;\">\n          <li><strong>Alert Sent:</strong> {{ $('Format Data & Generate Approval URL').item.json.notification_sent_at }}</li>\n          <li><strong>12 Hours Elapsed:</strong> {{ new Date().toISOString() }}</li>\n          <li><strong>Student Status:</strong> Still locked (needs_intervention)</li>\n          <li><strong>Action Taken:</strong> Auto-assigned default task</li>\n        </ul>\n      </div>\n      \n      <h3 style=\"color: #1a202c;\">ü§ñ Auto-Assigned Task:</h3>\n      <div style=\"background: #f0f4ff; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; margin: 20px 0;\">\n        <p style=\"margin: 0; color: #4b5563; line-height: 1.7;\">AUTO-ASSIGNED AFTER 12-HOUR TIMEOUT: Please review your recent quiz results and focus session. Contact your mentor immediately for personalized guidance and support.</p>\n      </div>\n      \n      <h3 style=\"color: #1a202c;\">üéØ Required Follow-Up Actions:</h3>\n      <ol style=\"color: #4b5563; line-height: 2;\">\n        <li><strong>Contact the student</strong> immediately to provide personalized guidance</li>\n        <li><strong>Review the student's history</strong> for patterns of poor performance</li>\n        <li><strong>Schedule a 1-on-1 session</strong> to address learning challenges</li>\n        <li><strong>Notify guardian</strong> if intervention is required beyond remedial tasks</li>\n        <li><strong>Document this case</strong> for quality assurance review</li>\n      </ol>\n      \n      <div style=\"text-align: center; margin: 30px 0;\">\n        <a href=\"{{ $('Format Data & Generate Approval URL').item.json.approval_url }}\" class=\"button\">üö® View Full Case Details</a>\n      </div>\n      \n      <div style=\"background: #fef2f2; border: 2px solid #e53e3e; padding: 20px; border-radius: 10px;\">\n        <strong style=\"color: #991b1b; font-size: 16px;\">‚ö†Ô∏è Process Improvement Notice:</strong>\n        <p style=\"margin: 10px 0 0 0; color: #7f1d1d; line-height: 1.6;\">This escalation indicates a gap in the mentoring workflow. Please review mentor availability and response time protocols.</p>\n      </div>\n    </div>\n    \n    <div class=\"footer\">\n      <p style=\"margin: 0 0 10px 0; font-size: 16px; font-weight: 600;\">Alcovia Intervention Engine</p>\n      <p style=\"margin: 0; font-size: 13px; opacity: 0.8;\">Critical Escalation - Automated Notification</p>\n      <p style=\"margin: 15px 0 0 0; font-size: 11px; opacity: 0.6;\">Workflow ID: {{ $('Format Data & Generate Approval URL').item.json.workflow_id }}</p>\n    </div>\n  </div>\n</body>\n</html>",
        "options": {}
      },
      "id": "escalation-email",
      "name": "Send Critical Escalation Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1450, 800],
      "notes": "Alerts head mentor and admin about 12-hour timeout"
    },
    {
      "parameters": {
        "jsCode": "// Log successful workflow completion\nconst studentId = $('Validate Approval & Security Check').first().json.student_id;\nconst completedAt = new Date().toISOString();\nconst workflowId = $('Format Data & Generate Approval URL').first().json.workflow_id;\n\nconsole.log('‚úÖ Alcovia Intervention Workflow Completed Successfully');\nconsole.log('Student:', studentId);\nconsole.log('Workflow ID:', workflowId);\nconsole.log('Completed at:', completedAt);\n\nreturn {\n  json: {\n    workflow_name: 'alcovia-intervention-engine',\n    status: 'completed_successfully',\n    student_id: studentId,\n    workflow_id: workflowId,\n    completed_at: completedAt,\n    path_taken: 'mentor_approval',\n    steps_executed: [\n      '1. Received student failure webhook',\n      '2. Formatted data and generated approval URL',\n      '3. Sent mentor notification email',\n      '4. Waited for mentor approval',\n      '5. Validated approval token',\n      '6. Called backend API to assign intervention',\n      '7. Sent confirmation email',\n      '8. Logged completion'\n    ],\n    metrics: {\n      total_execution_time_seconds: Math.floor((new Date() - new Date($('Format Data & Generate Approval URL').first().json.notification_sent_at)) / 1000),\n      webhook_received: true,\n      mentor_approved: true,\n      backend_api_success: true,\n      confirmation_sent: true\n    }\n  }\n};"
      },
      "id": "log-completion",
      "name": "Log Successful Workflow Completion",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 300],
      "notes": "Final step: Logs completion metrics for monitoring"
    },
    {
      "parameters": {
        "jsCode": "// Split workflow into two parallel execution paths\nconst data = $input.first().json;\n\n// Return two outputs:\n// Output 1 (index 0): Main path - continues to email and approval\n// Output 2 (index 1): Fail-safe path - starts 12-hour timer\n\nreturn [\n  {\n    json: {\n      ...data,\n      execution_path: 'main',\n      description: 'Primary workflow: wait for mentor approval'\n    }\n  },\n  {\n    json: {\n      ...data,\n      execution_path: 'failsafe',\n      description: 'Parallel fail-safe: 12-hour timeout monitor'\n    }\n  }\n];"
      },
      "id": "split-workflow",
      "name": "Split into Parallel Paths",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 600],
      "notes": "Creates two parallel execution paths: main + fail-safe"
    }
  ],
  "connections": {
    "Webhook - Student Failed Checkin": {
      "main": [
        [
          {
            "node": "Format Data & Generate Approval URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Data & Generate Approval URL": {
      "main": [
        [
          {
            "node": "Send Mentor Notification Email",
            "type": "main",
            "index": 0
          },
          {
            "node": "Split into Parallel Paths",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Mentor Notification Email": {
      "main": [
        [
          {
            "node": "Webhook - Wait for Mentor Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook - Wait for Mentor Approval": {
      "main": [
        [
          {
            "node": "Validate Approval & Security Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Approval & Security Check": {
      "main": [
        [
          {
            "node": "Assign Intervention (Backend API)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assign Intervention (Backend API)": {
      "main": [
        [
          {
            "node": "Check API Response Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check API Response Success": {
      "main": [
        [
          {
            "node": "Send Mentor Confirmation Email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send API Error Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Mentor Confirmation Email": {
      "main": [
        [
          {
            "node": "Log Successful Workflow Completion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split into Parallel Paths": {
      "main": [
        [],
        [
          {
            "node": "Wait 12 Hours (Fail-Safe Timer)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 12 Hours (Fail-Safe Timer)": {
      "main": [
        [
          {
            "node": "Check Student Current Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Student Current Status": {
      "main": [
        [
          {
            "node": "Is Student Still Locked?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Student Still Locked?": {
      "main": [
        [
          {
            "node": "Auto-Assign Default Task (Failsafe)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Critical Escalation Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": {},
  "tags": [
    {
      "createdAt": "2025-11-22T00:00:00.000Z",
      "updatedAt": "2025-11-22T00:00:00.000Z",
      "id": "1",
      "name": "alcovia"
    },
    {
      "createdAt": "2025-11-22T00:00:00.000Z",
      "updatedAt": "2025-11-22T00:00:00.000Z",
      "id": "2",
      "name": "education"
    },
    {
      "createdAt": "2025-11-22T00:00:00.000Z",
      "updatedAt": "2025-11-22T00:00:00.000Z",
      "id": "3",
      "name": "intervention"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-11-22T00:00:00.000Z",
  "versionId": "1.0.0"
}
